<!DOCTYPE html>

<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>GENESIS ‚Äì Outil d'analyse des ent√™tes de courrier √©lectroniques</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="https://www.interieur.gouv.fr/themes/custom/dsfr/src/images/logo/favicon.png">

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/utility/utilities.min.css">

  <style>
    body { margin: 0; background: #fff; }
    .fr-header, .fr-header__brand { filter: none !important; }

    .genesis-main {
      padding: 2rem 0;
    }

    .genesis-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    textarea {
      min-height: 360px;
      font-family: monospace;
    }

    .results {
      min-height: 360px;
      padding: 1rem;
      border: 1px solid var(--border-default-grey);
      background: var(--background-alt-grey);
      overflow-y: auto;
    }
  </style>
</head>

<body>

<!-- HEADER OFFICIEL -->
<header role="banner" class="fr-header">
  <div class="fr-header__body">
    <div class="fr-container">
      <div class="fr-header__body-row">
        <div class="fr-header__brand fr-enlarge-link">
          <div class="fr-header__brand-top">
            <div class="fr-header__logo">
              <p class="fr-logo">Minist√®re<br>de l‚ÄôInt√©rieur</p>
            </div>
          </div>
          <div class="fr-header__service">
            <p class="fr-header__service-title">GENESIS</p>
            <p class="fr-header__service-tagline">
              Outil d‚Äôanalyse des ent√™tes de courriers √©lectroniques
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- ================= VUE ANALYSE ================= -->
<div id="view-analyse">

<main class="genesis-main">
  <div class="fr-container">

<!-- üîπ BOUTON TUTORIEL -->
<div class="fr-grid-row fr-grid-row--right fr-mb-2w">
  <button id="btn-tuto" class="fr-btn fr-btn--secondary">
    Tutoriel
  </button>
</div>

<div class="genesis-grid">

  <!-- GAUCHE -->
  <section>
    <h2 class="fr-h5">Texte √† analyser</h2>

    <textarea
      id="inputText"
      class="fr-input"
      rows="6"
      placeholder="Collez ici l‚Äôent√™te brute du courrier √©lectronique‚Ä¶"></textarea>

    <fieldset class="fr-fieldset fr-mt-2w">
      <legend class="fr-fieldset__legend">
        Types d‚Äô√©l√©ments √† extraire
      </legend>

      <div class="fr-fieldset__content">

        <div class="fr-checkbox-group fr-mb-1w">
          <input type="checkbox" id="chk-ip">
          <label for="chk-ip">Adresses IP</label>
        </div>

        <div class="fr-checkbox-group">
          <input type="checkbox" id="chk-mail">
          <label for="chk-mail">Adresses e-mail</label>
        </div>

        <div class="fr-checkbox-group fr-mt-1w">
          <input type="checkbox" id="chk-agent">
          <label for="chk-agent">Informations sur l'appareil de l'exp√©diteur</label>
        </div>

      </div>
    </fieldset>

    <button id="btn-analyze" class="fr-btn fr-mt-2w">
      Analyser
    </button>
  </section>

  <!-- DROITE -->
  <section>
    <h2 class="fr-h5">R√©sultats</h2>
    <div id="results" class="results fr-text--sm">
      Aucun r√©sultat pour le moment.
    </div>
  </section>

</div>
</div>
</main>

</div>

<!-- ================= VUE TUTORIEL ================= -->
<div id="view-tuto" hidden>

  <div class="fr-container fr-mt-2w">
  <button
    id="btn-back"
    class="fr-btn fr-btn--tertiary fr-btn--icon-left">

    <span aria-hidden="true">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="currentColor"
        width="1.25em"
        height="1.25em"
        style="vertical-align: middle;"
      >
        <path d="M7.82843 10.9999H20V12.9999H7.82843L13.1924 18.3638L11.7782 19.778L4 11.9999L11.7782 4.22168L13.1924 5.63589L7.82843 10.9999Z"/>
      </svg>
    </span>

    Retour
  </button>
</div>

  <div class="fr-container fr-mt-4w">
    <h1 class="fr-h3">Comment r√©cup√©rer l‚Äôent√™te d‚Äôun courrier √©lectronique</h1>

    <p>
      Pour analyser un message, GENESIS a besoin de son <strong>ent√™te compl√®te</strong>.
    </p>

    <ol class="fr-mt-2w">
      <li>Ouvrez le courrier √©lectronique avec l'application "Messagerie Thunderbird"</li>
      <li>Utilisez le raccourci <strong>Ctrl + U</strong></li>
      <li>Copiez l‚Äôint√©gralit√© du contenu affich√©</li>
      <li>Revenez sur GENESIS</li>
      <li>Collez le contenu dans le champ ¬´ Texte √† analyser ¬ª</li>
    </ol>

    <p>
      Il faut bien r√©cup√©rer le courrier inital sur l'appareil de la victime. Si vous transf√©rez le message sur votre bo√Æte professionelle, les donn√©es seront modifi√©es. Vous pouvez au choix :
    </p>

      <ol class="fr-mt-2w">
      <li>Ou copier l'ent√™te depuis l'appareil de la victime, en affichant l'ent√™te du courrier √©lectronique via le bouton menu "...".</li>
      <li>Ou t√©l√©charger le courrier sur l'appareil de la victime via le bouton "t√©l√©charger" de sa messagerie (format .eml), avant de vous l'envoyer.</li>
    </ol>

  </div>

</div>

<!-- DSFR JS -->
<script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.module.min.js" type="module"></script>
<script src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.13.1/dist/dsfr/dsfr.nomodule.min.js" nomodule></script>

<!-- SCRIPT EXISTANT (INCHANG√â) -->
<script>

  function decodeQuotedPrintable(text) {
  return text
    // suppression des coupures soft line break
    .replace(/=\r?\n/g, '')
    // d√©codage hexad√©cimal (=2E ‚Üí .)
    .replace(/=([A-F0-9]{2})/gi, (_, hex) =>
      String.fromCharCode(parseInt(hex, 16))
    );
}

function looksLikeTime(value) {
  return /^\d{1,2}:\d{2}:\d{2}$/.test(value);
}

  const REGEX_IPV4 = /\b(?:(?:25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|1?\d?\d)\b/g;
  const REGEX_IPV6 = /\b(?:[a-fA-F0-9]{1,4}:){2,7}[a-fA-F0-9]{1,4}\b|\b(?:[a-fA-F0-9]{1,4}:){1,7}:|\b:(?::[a-fA-F0-9]{1,4}){1,7}\b/g;
  const REGEX_MAIL = /\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b/g;

function extractUserAgentInfo(text) {
  const lines = text.split(/\r?\n/);

  const mimeLine = lines.find(l => /^mime-version:/i.test(l));
  const xMailerLine = lines.find(l => /^x-mailer:/i.test(l));
  const uaLine = lines.find(l =>
    /^user-agent:/i.test(l) || /^x-user-agent:/i.test(l)
  );

  let source = '';
  let value = '';

  if (mimeLine && /\(.*\)/.test(mimeLine)) {
    source = 'Mime-Version';
    value = mimeLine.match(/\((.*)\)/)[1];
  } else if (xMailerLine) {
    source = 'X-Mailer';
    value = xMailerLine.split(':').slice(1).join(':').trim();
  } else if (uaLine) {
    source = 'User-Agent';
    value = uaLine.split(':').slice(1).join(':').trim();
  } else {
    return null;
  }

  let device = 'Ordinateur';
  let os = 'Inconnu';
  let app = 'Inconnue';
  let version = '';

  /* ================= OS + APP ================= */

  // Apple Mail / macOS
  if (/mac os x mail/i.test(value) || /apple mail/i.test(value)) {
    os = 'macOS (Apple)';
    app = 'Apple Mail';

    const v = value.match(/mail\s([\d.]+)/i);
    if (v) version = v[1];
  }

  // Microsoft Outlook
  else if (/outlook/i.test(value)) {
    os = 'Windows';
    app = 'Microsoft Outlook';

    const v = value.match(/outlook[\s\/]?([\d.]+)/i);
    if (v) version = v[1];
  }

  // Thunderbird
  else if (/thunderbird\/([\d.]+)/i.test(value)) {
    app = 'Mozilla Thunderbird';
    version = value.match(/thunderbird\/([\d.]+)/i)[1];

    if (/windows/i.test(value)) os = 'Windows';
    else if (/mac os x|macintosh/i.test(value)) os = 'macOS';
    else if (/linux/i.test(value)) os = 'Linux';
  }

  // iPhone / iPad
  if (/iphone|ipad/i.test(value)) {
    device = 'Mobile';
    os = 'iOS (Apple)';
  }

  // Android
  if (/android/i.test(value)) {
    device = 'Mobile';
    os = 'Android';
  }

  return {
    source,
    raw: value,
    device,
    os,
    app,
    version
  };
}

 function extractDateUTC(text) {
  const match = text.match(/^Date:\s*(.+)$/mi);
  if (!match) return null;

  const date = new Date(match[1]);
  if (isNaN(date.getTime())) return null;

  return date.toISOString().replace('T', ' ').replace('Z', ' UTC');
}

function extractLastReceivedUTC(text) {
  // Normalisation des lignes
  const lines = text.split(/\r?\n/);

  // Reconstitution des blocs Received (RFC compliant)
  let receivedBlocks = [];
  let current = null;

  for (const line of lines) {
    if (/^Received:/i.test(line)) {
      if (current) receivedBlocks.push(current);
      current = line;
    } else if (current && /^\s+/.test(line)) {
      current += ' ' + line.trim();
    } else {
      if (current) {
        receivedBlocks.push(current);
        current = null;
      }
    }
  }

  if (current) receivedBlocks.push(current);

  if (!receivedBlocks.length) return null;

  // Le dernier Received = d√©p√¥t initial
  const lastReceived = receivedBlocks[receivedBlocks.length - 1];

  // Extraction de la date apr√®s le ;
  const dateMatch = lastReceived.match(/;\s*(.+)$/);
  if (!dateMatch) return null;

  const date = new Date(dateMatch[1]);
  if (isNaN(date.getTime())) return null;

return date.toISOString()
  .replace('T', ' ')
  .replace(/\.\d{3}Z$/, ' UTC');
}

/* ================= FILTRES TECHNIQUES ================= */

function isPublicIP(ip) {
  // Exclusions RFC / techniques
  if (
    ip.startsWith('10.') ||
    ip.startsWith('127.') ||
    ip.startsWith('192.168.') ||
    /^172\.(1[6-9]|2\d|3[0-1])\./.test(ip) ||
    ip === '0.0.0.0'
  ) {
    return false;
  }
  return true;
}

function isHumanEmail(email) {
  const technicalPatterns = [
    /^[a-f0-9-]{32,}@/i,        // UUID / GUID longs
    /^[a-f0-9-]{20,}@/i,
    /^[a-z0-9]{16,}@/i,         // hash brut
    /^[a-z]@/i,                 // e@domaine
    /^mailer-daemon@/i,
    /^postmaster@/i,
    /^no-reply@/i,
    /^noreply@/i
  ];

  return !technicalPatterns.some(re => re.test(email));
}

  document.getElementById('btn-analyze').addEventListener('click', () => {
    const rawText = document.getElementById('inputText').value;
    const text = decodeQuotedPrintable(rawText);
    const wantIP = document.getElementById('chk-ip').checked;
    const wantMail = document.getElementById('chk-mail').checked;
    const wantAgent = document.getElementById('chk-agent').checked;
    const output = document.getElementById('results');

    output.innerHTML = '';

  if (!wantIP && !wantMail && !wantAgent) {
  output.textContent = 'S√©lectionnez au moins un type d‚Äôanalyse.';
  return;
}

if ((wantIP || wantMail || wantAgent) && !text.trim()) {
  output.textContent = 'Veuillez coller une ent√™te avant de lancer l‚Äôanalyse.';
  return;
}

    let blocks = [];

if (wantIP) {
const ipv4 = (text.match(REGEX_IPV4) || []).filter(ip => !looksLikeTime(ip));
const ipv6 = text.match(REGEX_IPV6) || [];
const allIPs = [...ipv4, ...ipv6];

  const publicIPs = allIPs.filter(isPublicIP);
  const technicalIPs = allIPs.filter(ip => !isPublicIP(ip));

  const uniqPublic = [...new Set(publicIPs)].sort();
  const uniqTech = [...new Set(technicalIPs)].sort();

  const dateUTC = extractLastReceivedUTC(text);

let html = `
  <strong>Adresses IP (${uniqPublic.length})</strong><br>
  <div class="fr-mb-2w fr-text--sm">
    Horodatage : ${dateUTC}
  </div>
`;

html += uniqPublic.length
  ? uniqPublic.map(ip => `‚Ä¢ ${ip}`).join('<br>')
  : 'Aucune adresse IP publique trouv√©e';

  if (uniqTech.length) {
    html += `
      <details class="fr-mt-2w">
        <summary>Voir les r√©sultats techniques (${uniqTech.length})</summary>
        <div class="fr-mt-1w fr-text--sm">
          ${uniqTech.map(ip => `‚Ä¢ ${ip}`).join('<br>')}
        </div>
      </details>
    `;
  }

  blocks.push(html);
}

   if (wantMail) {
  const allMails = text.match(REGEX_MAIL) || [];

  const humanMails = allMails.filter(isHumanEmail);
  const technicalMails = allMails.filter(m => !isHumanEmail(m));

  const uniqHuman = [...new Set(humanMails)].sort();
  const uniqTech = [...new Set(technicalMails)].sort();

  let html = `<strong>Adresses e-mail (${uniqHuman.length})</strong><br><br>`;

  html += uniqHuman.length
    ? uniqHuman.join('<br>')
    : 'Aucune adresse e-mail pertinente trouv√©e';

  if (uniqTech.length) {
    html += `
      <details class="fr-mt-2w">
        <summary>Voir les r√©sultats techniques (${uniqTech.length})</summary>
        <div class="fr-mt-1w fr-text--sm">
          ${uniqTech.join('<br>')}
        </div>
      </details>
    `;
  }

  blocks.push(html);
}

if (wantAgent) {
  const agentInfo = extractUserAgentInfo(text);

  if (!agentInfo) {
    blocks.push(
      `<strong>Appareil utilis√© et application de l'exp√©diteur</strong><br>Aucune information trouv√©e`
    );
  } else {
    blocks.push(
      `<strong>Appareil utilis√© et application de l'exp√©diteur</strong><br>
      <ul>
        <li><strong>Syst√®me :</strong> ${agentInfo.os}</li>
        <li><strong>Application :</strong> ${agentInfo.app}</li>
        ${agentInfo.version ? `<li><strong>Version :</strong> ${agentInfo.version}</li>` : ''}
        <li><strong>Cha√Æne brute : </strong><code>${agentInfo.raw}</code></li>
      </ul>`
    );
  }
}

    output.innerHTML = blocks.join('<br><br>');
  });
</script>

<!-- SCRIPT TUTORIEL (NOUVEAU, ISOL√â) -->
<script>
  const viewAnalyse = document.getElementById('view-analyse');
  const viewTuto = document.getElementById('view-tuto');
  const btnTuto = document.getElementById('btn-tuto');
  const btnBack = document.getElementById('btn-back');

  btnTuto.addEventListener('click', () => {
    viewAnalyse.hidden = true;
    viewTuto.hidden = false;
    window.scrollTo(0, 0);
  });

  btnBack.addEventListener('click', () => {
    viewTuto.hidden = true;
    viewAnalyse.hidden = false;
    window.scrollTo(0, 0);
  });
</script>

</body>
</html>
